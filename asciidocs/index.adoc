= Microservices with Quarkus
Thomas W. Stütz
1.0.0, 2021-09-26: Excerpt from course "Antonio Goncalves - Microservices with Quarkus"
ifndef::imagesdir[:imagesdir: images]
//:toc-placement!:  // prevents the generation of the doc at this position, so it can be printed afterwards
:sourcedir: ../src/main/java
:icons: font
:sectnums:    // Nummerierung der Überschriften / section numbering
:sectnumlevels: 5
:toc: left

//Need this blank line after ifdef, don't know why...
ifdef::backend-html5[]

// print the toc here (not at the default position)
//toc::[]

== Preface

* This is only an excerpt of this course:
** https://agoncal.teachable.com/p/course-building-microservices-with-quarkus[, window="_blank"]
** https://www.udemy.com/course/quarkus-building-microservices-with-quarkus[, window="_blank"]
* It is strongly recommended to work through the original course.

* Course-repo: https://github.com/agoncal/agoncal-course-quarkus-microservices[agoncal/agoncal-course-quarkus-microservices, window="_blank"]

== Monoliths vs. Microservices

image:005-monolith-vs-microservice.png[]

== Preparations

=== JDK

[source, bash]
----
java -version
----

----
openjdk version "17" 2021-09-14
OpenJDK Runtime Environment Temurin-17+35 (build 17+35)
OpenJDK 64-Bit Server VM Temurin-17+35 (build 17+35, mixed mode, sharing)
----


A good choice for the Java JDK is https://adoptium.net/[Adoptium/Temurin, window="_blank"]

[%autowidth]
|===
|OS |How to install

|Windows
a|
. install https://sdkman.io/[sdkman, window="_blank"]
. `sdk install java 17.0.0-tem`
* https://api.sdkman.io/2/candidates/java/linux/versions/list?installed=[Available JDK-versions, window="_blank"]
|linux (Ubuntu)
|`sudo apt install openjdk-11-jdk`

|MacOS
|`brew install --cask temurin`

|===

* JDK 11 is sufficient - Quarkus uses Java 11


=== GraalVM

* https://www.graalvm.org[GraalVM, window="_blank"]
* https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-21.2.0[Download GRAALVM from github, window="_blank"]

.Erstellen eines Symlinks
----
ln -s /opt/graalvm-ce-java16-21.2.0 /opt/graalvm
----

----
export GRAALVM_HOME=/opt/graalvm/Contents/Home
env | grep GRAAL
$GRAALVM_HOME/bin/java -version
$GRAALVM_HOME/bin/native-image --version
----

.to install https://www.graalvm.org/reference-manual/native-image/#install-native-image[native-image]
[source, bash]
----
$GRAALVM_HOME/bin/gu install native-image
----

.https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-21.2.0[Entfernen des Quarantäne Flags bei macOS]
[source, bash]
----
sudo xattr -r -d com.apple.quarantine path/to/graalvm/folder/
----

=== Maven

.Installieren von maven unter Linux
----
sudo apt install maven
----

[source, bash]
----
mvn -version
----

=== Docker



[source, bash]
----
docker version
----

=== RestClient

==== curl

[source, bash]
----
curl --version
----

==== httpie

[source, bash]
----
http --version
----

== Bootstrapping the Microservices

.Create a project root folder
[source, bash]
----
mkdir vintage-store
cd vintage-store
----

[source, bash]
----
#!/usr/bin/env bash
mvn -U io.quarkus:quarkus-maven-plugin:create \
        -DprojectGroupId=at.htl.microservices \
        -DprojectArtifactId=rest-number \
        -DclassName="at.htl.microservices.number.NumberResource" \
        -Dpath="/api/numbers" \
        -Dextensions="resteasy-jsonb, smallrye-openapi"
----

[source, bash]
----
#!/usr/bin/env bash
mvn -U io.quarkus:quarkus-maven-plugin:create \
        -DprojectGroupId=at.htl.microservices \
        -DprojectArtifactId=rest-book \
        -DclassName="at.htl.microservices.book.BookResource" \
        -Dpath="/api/books" \
        -Dextensions="resteasy-jsonb, smallrye-openapi"
----

.open the project "vintage-store"
image:010-book-numbers-in-ide.png[]

[source, bash]
----
cd rest-number
./mvnw clean quarkus:dev
----


image:015-first-run.png[]

== Develop the Number Microservice



=== Exposing the Number REST Endpoint

.at.htl.microservices.number.IsbnNumbers
[source,java]
----
package at.htl.microservices.number;

import java.time.Instant;

public class IsbnNumbers {

    public String isbn10;
    public String isbn13;
    public Instant generationDate;

    @Override
    public String toString() {
        return "IsbnNumbers{" +
                "isbn10='" + isbn10 + '\'' +
                ", isbn13='" + isbn13 + '\'' +
                ", generationDate=" + generationDate +
                '}';
    }
}
----

.at.htl.microservices.number.NumberResource
[source,java]
----
package at.htl.microservices.number;

import org.jboss.logging.Logger;

import javax.inject.Inject;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import java.time.Instant;
import java.util.Random;

@Path("/api/numbers")
public class NumberResource {

    @Inject
    Logger logger; // <.>

    @GET
    @Produces(MediaType.APPLICATION_JSON)
    public IsbnNumbers generateIsbnNumbers() {
        IsbnNumbers isbnNumbers = new IsbnNumbers();
        isbnNumbers.isbn13 = "13-" + new Random().nextInt(100_000_000);
        isbnNumbers.isbn10 = "10-" + new Random().nextInt(100_000);
        isbnNumbers.generationDate = Instant.now();
        logger.info("Numbers generated " + isbnNumbers); // <.>

        return isbnNumbers;
    }
}
----

<.> inject a logger
<.> use the logger

image:020-IsbnNumbers.png[]

=== Excursus: JSON-B


|===
|API |Description

|`@JsonbProperty`
|Allows customisation of a field name

|`@JsonbTransient`
|Prevents mapping of a field

|`@JsonbDateFormat`
|Customises the date format of a field

|`@JsonbNumberFormat`
|Customises the number format of a field

|===




[source,bash]
----
http localhost:8080/api/numbers
----

.at.htl.microservices.number.IsbnNumbers
[source,java]
----
public class IsbnNumbers {

    @JsonbProperty("isbn_13")
    public String isbn13;
    @JsonbProperty("isbn_10")
    public String isbn10;
    @JsonbTransient
    public Instant generationDate;

    // toString()
}
----


.Output
----
HTTP/1.1 200 OK
Content-Length: 46
Content-Type: application/json

{
    "isbn_10": "10-76318",
    "isbn_13": "13-70991667"
}

----

=== Excursus: OpenAPI

|===
|API |Description

|`@APIResponse`
|Describes the endpoint's response

|`@Operation`
|Describes a single API operation on a path

|`@OpenAPIDefinition`
|Root document object of the OpenAPI document

|`@Parameter`
|The name of the method parameter

|`@Schema`
|Allows the definition of input and output data types

|`@Tag`
|Used to add tags to the REST endpoint contract

|===

=== OpenAPI/Swagger

.at.htl.microservices.number.IsbnNumbers
[source,java]
----
package at.htl.microservices.number;

import org.eclipse.microprofile.openapi.annotations.media.Schema;

import javax.json.bind.annotation.JsonbProperty;
import javax.json.bind.annotation.JsonbTransient;
import java.time.Instant;

@Schema(description = "Several ISBN numbers for books")
public class IsbnNumbers {

    @Schema(required = true)
    @JsonbProperty("isbn_13")
    public String isbn13;
    @Schema(required = true)
    @JsonbProperty("isbn_10")
    public String isbn10;
    @JsonbTransient
    public Instant generationDate;

    @Override
    public String toString() {
        return "IsbnNumbers{" +
                "isbn10='" + isbn10 + '\'' +
                ", isbn13='" + isbn13 + '\'' +
                ", generationDate=" + generationDate +
                '}';
    }
}

----

.at.htl.microservices.number.NumberResource
[source,java]
----
package at.htl.microservices.number;

import org.eclipse.microprofile.openapi.annotations.Operation;
import org.eclipse.microprofile.openapi.annotations.tags.Tag;
import org.jboss.logging.Logger;

import javax.inject.Inject;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import java.time.Instant;
import java.util.Random;

@Path("/api/numbers")
@Tag(name="")
public class NumberResource {

    @Inject
    Logger logger;

    @GET
    @Produces(MediaType.APPLICATION_JSON)
    @Operation(
            summary = "Generate book numbers",
            description = "ISBN 13 and ISBN 10 numbers"
    )
    public IsbnNumbers generateIsbnNumbers() {
        IsbnNumbers isbnNumbers = new IsbnNumbers();
        isbnNumbers.isbn13 = "13-" + new Random().nextInt(100_000_000);
        isbnNumbers.isbn10 = "10-" + new Random().nextInt(100_000);
        isbnNumbers.generationDate = Instant.now();
        logger.info("Numbers generated " + isbnNumbers);

        return isbnNumbers;
    }
}
----

.at.htl.microservices.number.NumberMicroservice
[source,java]
----
package at.htl.microservices.number;

import org.eclipse.microprofile.openapi.annotations.ExternalDocumentation;
import org.eclipse.microprofile.openapi.annotations.OpenAPIDefinition;
import org.eclipse.microprofile.openapi.annotations.info.Contact;
import org.eclipse.microprofile.openapi.annotations.info.Info;
import org.eclipse.microprofile.openapi.annotations.tags.Tag;

import javax.ws.rs.core.Application;

@OpenAPIDefinition(
        info = @Info(
                title = "Number API",
                description = "Generates ISBN book numbers",
                version = "1.0",
                contact = @Contact(name = "@my-name", url = "bit.ly/htl-leonding")
        ),
        externalDocs = @ExternalDocumentation(url = "bit.ly/htl-leonding"),
        tags = {
                @Tag(name = "api", description = "Public API"),
                @Tag(name = "numbers", description = "Interested in numbers")
        }
)
public class NumberMicroservice extends Application {
}
----

[source,bash]
----
http localhost:8080/q/openapi
----

.Output in yaml
[source,yaml]
----
openapi: 3.0.3
info:
  title: Number API
  description: Generates ISBN book numbers
  contact:
    name: '@my-name'
    url: bit.ly/htl-leonding
  version: "1.0"
externalDocs:
  url: bit.ly/htl-leonding
tags:
- name: api
  description: Public API
- name: numbers
  description: Interested in numbers
- name: ""
paths:
  /api/numbers:
    get:
      tags:
      - ""
      summary: Generate book numbers
      description: ISBN 13 and ISBN 10 numbers
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IsbnNumbers'
components:
  schemas:
    IsbnNumbers:
      description: Several ISBN numbers for books
      required:
      - isbn_10
      - isbn_13
      type: object
      properties:
        isbn_10:
          type: string
        isbn_13:
          type: string

----

[source,bash]
----
http localhost:8080/q/openapi Accept:application/json
----

.Output in json
[source,json]
----
{
    "components": {
        "schemas": {
            "IsbnNumbers": {
                "description": "Several ISBN numbers for books",
                "properties": {
                    "isbn_10": {
                        "type": "string"
                    },
                    "isbn_13": {
                        "type": "string"
                    }
                },
                "required": [
                    "isbn_10",
                    "isbn_13"
                ],
                "type": "object"
            }
        }
    },
    "externalDocs": {
        "url": "bit.ly/htl-leonding"
    },
    "info": {
        "contact": {
            "name": "@my-name",
            "url": "bit.ly/htl-leonding"
        },
        "description": "Generates ISBN book numbers",
        "title": "Number API",
        "version": "1.0"
    },
    "openapi": "3.0.3",
    "paths": {
        "/api/numbers": {
            "get": {
                "description": "ISBN 13 and ISBN 10 numbers",
                "responses": {
                    "200": {
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/IsbnNumbers"
                                }
                            }
                        },
                        "description": "OK"
                    }
                },
                "summary": "Generate book numbers",
                "tags": [
                    ""
                ]
            }
        }
    },
    "tags": [
        {
            "description": "Public API",
            "name": "api"
        },
        {
            "description": "Interested in numbers",
            "name": "numbers"
        },
        {
            "name": ""
        }
    ]
}
----

* http://localhost:8080/q/swagger-ui/

image:021-swagger-ui.png[]


[source,java]
----

----


=== Change the Port for the Endpoints


* We will change the port from 8080 to 8701

.src/main/resources/application.properties
[source,properties]
----
quarkus.http.port=8701
----

.We test the port
[source,shell]
----
http :8701/api/numbers
----

.output
[source,http request]
----
HTTP/1.1 200 OK
Content-Length: 46
Content-Type: application/json

{
    "isbn_10": "10-86168",
    "isbn_13": "13-67790513"
}
----

=== Create a banner file

* https://patorjk.com/software/taag
* ie font "ANSI Shadow"

.src/main/resources/default_banner.txt
----
███╗   ██╗██╗   ██╗███╗   ███╗██████╗ ███████╗██████╗
████╗  ██║██║   ██║████╗ ████║██╔══██╗██╔════╝██╔══██╗
██╔██╗ ██║██║   ██║██╔████╔██║██████╔╝█████╗  ██████╔╝
██║╚██╗██║██║   ██║██║╚██╔╝██║██╔══██╗██╔══╝  ██╔══██╗
██║ ╚████║╚██████╔╝██║ ╚═╝ ██║██████╔╝███████╗██║  ██║
╚═╝  ╚═══╝ ╚═════╝ ╚═╝     ╚═╝╚═════╝ ╚══════╝╚═╝  ╚═╝
----

=== Dev UI

.http://localhost:8701/q/dev/
image::030-dev-ui.png[]

.http://localhost:8701/q/dev/io.quarkus.quarkus-vertx-http/config
image::031-dev-ui-config.png[]

=== Testing the Number Microservice

* JUnit and restAssured sind bereits in der pom.xml eingetragen

.at.htl.microservices.number.NumberResourceTest
[source,java]
----
package at.htl.microservices.number;

import io.quarkus.test.junit.QuarkusTest;
import org.junit.jupiter.api.Test;

import static io.restassured.RestAssured.given;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.startsWith;
import static org.hamcrest.Matchers.hasKey;
import static org.hamcrest.Matchers.not;

@QuarkusTest
public class NumberResourceTest {

    @Test
    public void testHelloEndpoint() {
        given()
          .when().get("/api/numbers")
          .then()
             .statusCode(200)
             .body("isbn_13", startsWith("13-"))
             .body("isbn_10", startsWith("10-"))
             .body(not(hasKey("generationDate")));
    }
}
----


== Develop the Book Microservice

.src/main/java/at/htl/microservices/book/Book.java
[source,java]
----
package at.htl.microservices.book;

import java.time.Instant;

public class Book {

    public String isbn13;
    public String title;
    public String author;
    public int yearOfPublication;
    public String genre;
    public Instant creationTime;

    @Override
    public String toString() {
        return "Book{" +
                "isbn13='" + isbn13 + '\'' +
                ", title='" + title + '\'' +
                ", author='" + author + '\'' +
                ", yearOfPublication=" + yearOfPublication +
                ", genre='" + genre + '\'' +
                ", creationTime=" + creationTime +
                '}';
    }
}
----

.src/main/java/at/htl/microservices/book/BookResource.java
[source,java]
----
package at.htl.microservices.book;

import org.jboss.logging.Logger;

import javax.inject.Inject;
import javax.ws.rs.*;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import java.time.Instant;

@Path("/api/books")
public class BookResource {

    @Inject
    Logger logger;

    @POST
    @Produces(MediaType.APPLICATION_JSON)
    @Consumes(MediaType.APPLICATION_FORM_URLENCODED)
    public Response createABook(
            @FormParam("title") String title,
            @FormParam("author") String author,
            @FormParam("year") int yearOfPubication,
            @FormParam("genre") String genre
    ) {
        Book book = new Book();
        book.isbn13 = "We will get it from the Number Microservice";
        book.title = title;
        book.author = author;
        book.yearOfPublication = yearOfPubication;
        book.genre = genre;
        book.creationTime = Instant.now();

        logger.infof("Book created: %s", book);
        return Response.status(201).entity(book).build();
    }
}
----

.Try it with curl
[source,shell]
----
curl -X POST http://localhost:8080/api/books \
     -d "title=Quarkus&author=Susi&year=2021&genre=IT"
----

.response
[source,json]
----
{"author":"Susi","creationTime":"2021-10-07T22:40:42.540116Z","genre":"IT","isbn13":"We will get it from the Number Microservice","title":"Quarkus","yearOfPublication":2021}
----

=== Customizing the JSON Output


.src/main/java/at/htl/microservices/book/Book.java
[source,java]
----
public class Book {

    @JsonbProperty("isbn_13") // <.>
    public String isbn13;
    public String title;
    public String author;
    @JsonbProperty("year_of_publication")  // <.>
    public int yearOfPublication;
    public String genre;
    @JsonbProperty("creation_date") // <.>
    @JsonbDateFormat("yyyy-MM-dd") // <.>
    public Instant creationTime;

    // ...
}
----

.Try it with curl
[source,shell]
----
curl -X POST http://localhost:8080/api/books \
     -d "title=Quarkus&author=Susi&year=2021&genre=IT"
----

.response
[source,json]
----
{"author":"Susi","creation_date":"2021-10-07","genre":"IT","isbn_13":"We will get it from the Number Microservice","title":"Quarkus","year_of_publication":2021}
----

.httpie
[source,shell script]
----
http --form POST :8080/api/books title='Quarkus' author='Susi' year=2021 genre='IT'
----

.response
[source,json]
----
HTTP/1.1 201 Created
Content-Length: 163
Content-Type: application/json

{
    "author": "Susi",
    "creation_date": "2021-10-11",
    "genre": "IT",
    "isbn_13": "13-we will get it from the number microservice",
    "title": "Quarkus",
    "year_of_publication": 2021
}
----

=== Documenting the Endpoint

* start the book-microservice and look at the swagger

.src/main/java/at/htl/microservices/book/BookResource.java
[source,java, highlight=2;11-14]
----
@Path("/api/books")
@Tag(name = "Book REST endpoint")
public class BookResource {

    @Inject
    Logger logger;

    @POST
    @Produces(MediaType.APPLICATION_JSON)
    @Consumes(MediaType.APPLICATION_FORM_URLENCODED)
    @Operation(
            summary = "Creates a book",
            description = "Creates a book with an ISBN number"
    )
    public Response createABook(
            @FormParam("title") String title,
            @FormParam("author") String author,
            @FormParam("year") int yearOfPubication,
            @FormParam("genre") String genre
    ) {
         // ...
    }
}
----


.src/main/java/at/htl/microservices/book/Book.java
[source,java,highlight=5;7;15]
----
@Schema(description = "This is a book")
public class Book {

    @JsonbProperty("isbn_13")
    @Schema(required = true)
    public String isbn13;
    @Schema(required = true)
    public String title;
    public String author;
    @JsonbProperty("year_of_publication")
    public int yearOfPublication;
    public String genre;
    @JsonbProperty("creation_date")
    @JsonbDateFormat("yyyy-MM-dd")
    @Schema(implementation = String.class, format = "date")
    public Instant creationTime;

    //...
}
----

.src/main/resources/application.properties
[source,properties]
----
mp.openapi.extensions.smallrye.info.title=Book API
mp.openapi.extensions.smallrye.info.version=1.0
mp.openapi.extensions.smallrye.info.description=Creates books
mp.openapi.extensions.smallrye.info.contact.name=@susi
mp.openapi.extensions.smallrye.info.contact.url=https://twitter.com/susi
----

image::032-swagger.png[]


=== Configuring Quarkus

* https://patorjk.com/software/taag
* ie font "ANSI Shadow"

.src/main/resources/default_banner.txt
----
██████╗  ██████╗  ██████╗ ██╗  ██╗
██╔══██╗██╔═══██╗██╔═══██╗██║ ██╔╝
██████╔╝██║   ██║██║   ██║█████╔╝
██╔══██╗██║   ██║██║   ██║██╔═██╗
██████╔╝╚██████╔╝╚██████╔╝██║  ██╗
╚═════╝  ╚═════╝  ╚═════╝ ╚═╝  ╚═╝
----


.src/main/resources/application.properties
[source,properties, highlight=1]
----
quarkus.http.port=8702

mp.openapi.extensions.smallrye.info.title=Book API
mp.openapi.extensions.smallrye.info.version=1.0
mp.openapi.extensions.smallrye.info.description=Creates books
mp.openapi.extensions.smallrye.info.contact.name=@susi
mp.openapi.extensions.smallrye.info.contact.url=https://twitter.com/susi
----


=== Testing the Endpoint

.at/htl/microservices/book/BookResourceTest.java
[source,java]
----
package at.htl.microservices.book;

import io.quarkus.test.junit.QuarkusTest;
import org.junit.jupiter.api.Test;

import static io.restassured.RestAssured.given;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.CoreMatchers.startsWith;

@QuarkusTest
public class BookResourceTest {

    @Test
    public void shouldCreateABook() {
        given()
                .formParam("title", "Understanding Quarkus")
                .formParam("author","Susi")
                .formParam("year",2020)
                .formParam("genre", "IT")
          .when()
                .post("/api/books")
          .then()
                .statusCode(201)
                .body("isbn_13", startsWith("13-"))
                .body("title", is("Understanding Quarkus"))
                .body("author", is("Susi"))
                .body("year_of_publication", is(2020))
                .body("genre", is("IT"))
                .body("creation_date", startsWith("2021"));
    }
}
----


== Establishing a Resilient Communication

* https://microprofile.io/project/eclipse/microprofile-rest-client
* microprofile REST Client is built on top of JAX-RS Client
* Type-safe way to invoke endpoints
* Injecting a proxy interface

[%autowidth]
|===
|API |Description

|@RegisterRestClient
|Marker annotation to register a rest client at runtime

|@RestClient
|Injects an instance of a REST client in a type-safe way

|===

.add rest-client extension to book-microservice
[source,bash]
----
./mvnw quarkus:add-extension -Dextensions="rest-client"
----


.start book-microservice
[source,shell]
----
./mvnw clean quarkus:dev
----

.start number-microservice
[source,bash]
----
cd ..
cd rest-number
./mvnw clean quarkus:dev
----

.requests.http
[source,shell]
----
GET localhost:8701/api/numbers

###

POST localhost:8702/api/books
Content-Type: application/x-www-form-urlencoded

title=Quarkus&author=Susi&year=2021&genre=IT

###
----

=== Implement REST-Client

.at.htl.microservices.book.NumberProxy
[source,java,highlight=10;12;16]
----
package at.htl.microservices.book;

import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

@RegisterRestClient
@Path("/api/numbers")
public interface NumberProxy {

    @GET
    @Produces(MediaType.APPLICATION_JSON)
    IsbnThirteen generateIsbnNumbers();

}
----

.at.htl.microservices.book.IsbnThirteen
[source,java]
----
package at.htl.microservices.book;

import javax.json.bind.annotation.JsonbProperty;

public class IsbnThirteen {

    @JsonbProperty("isbn_13") // <.>
    public String isbn13;

}
----

<.> You have to change the name, so it works

.at.htl.microservices.book.BookResource
[source,java,highlight=16-18;28]
----
package at.htl.microservices.book;

import org.eclipse.microprofile.openapi.annotations.Operation;
import org.eclipse.microprofile.openapi.annotations.tags.Tag;
import org.eclipse.microprofile.rest.client.inject.RestClient;

// import ...

@Path("/api/books")
@Tag(name="Book REST endpoint")
public class BookResource {

    @Inject
    Logger logger;

    @RestClient
    NumberProxy proxy;

    @POST
    @Produces(MediaType.APPLICATION_JSON)
    @Consumes(MediaType.APPLICATION_FORM_URLENCODED)
    //  @Operation(...)
    public Response createABook(
            //...
    ) {
        Book book = new Book();
        book.isbn13 = proxy.generateIsbnNumbers().isbn13;
        book.title = title;
        book.author = author;
        book.yearOfPublication = yearOfPublication;
        book.genre = genre;
        book.creationTime = Instant.now();

        logger.infof("Book created: %s", book);
        return Response.status(201).entity(book).build();
    }
}
----

[source,properties,highlight=3]
----
quarkus.http.port=8702

at.htl.microservices.book.NumberProxy/mp-rest/url=http://localhost:8701
----

.Does it work? (requests.http)
[source]
----
POST localhost:8702/api/books
Content-Type: application/x-www-form-urlencoded

title=Quarkus&author=Susi&year=2021&genre=IT
----

.Yes, it works!
----
http://localhost:8702/api/books

HTTP/1.1 201 Created
Content-Length: 128
Content-Type: application/json

{
  "author": "Susi",
  "creation_date": "2021-10-14",
  "genre": "IT",
  "isbn_13": "13-14543507",
  "title": "Quarkus",
  "year_of_publication": 2021
}
----

* It is possible to shorten the endpoint url.

[source,properties,highlight=3]
----
quarkus.http.port=8702

number.proxy/mp-rest/url=http://localhost:8701
----

.Add the config key to the annotation
[source,java,highlight=3]
----
// ...

@RegisterRestClient(configKey = "number.proxy")
@Path("/api/numbers")
public interface NumberProxy {

    // ...

}
----

* Check, if it is still working

=== Mocking the Communication

* https://quarkus.io/guides/getting-started-testing#mock-support
* Mocking ... Simulate the behavior of a real objects
* Quarkus has a built-in mocking functionality
* When this is not sufficient, you can use the JUnit Mockito extension
* So we can't test the book microservice w/o running the number microservice

[%autowidth]
|===
|API |Description

|@Mock
|Overrides the bean you wish to mock with another class

|QuarkusMock
|Used to temporarily mock out any bean

|@InjectMock
|Results in a mock being injected in test methods

|InjectSpy
|Spies the logical path that was taken

|===

==== Stop the number-microservice

.response of the POST request
----
http://localhost:8702/api/books

HTTP/1.1 500 Internal Server Error
content-type: text/html; charset=utf-8
content-length: 19595
----

====

















